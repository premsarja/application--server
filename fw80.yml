- name: Add iptables rules using iptables-restore
  hosts: all
  become: yes
  tasks:
    - name: Save iptables rules to a temporary file
      ansible.builtin.copy:
        content: |
          # Generated by iptables-save v1.8.8 (nf_tables) on Fri Nov 24 09:58:13 2023
          *filter
          :INPUT ACCEPT [0:0]
          :FORWARD ACCEPT [0:0]
          :OUTPUT ACCEPT [0:0]
          -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
          -A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
          COMMIT
          # Completed on Fri Nov 24 09:58:13 2023
        dest: /tmp/iptables_rules
        remote_src: yes

    - name: Apply iptables rules from the temporary file
      ansible.builtin.shell: iptables-restore --noflush /tmp/iptables_rules
